<form class='calendar-form' action="/schedule" method="post">
    <div class="schedule-container">
        <div class="schedule-header">
            <div class="schedule-cell"></div>
            <div class="schedule-cell">Monday</div>
            <div class="schedule-cell">Tuesday</div>
            <div class="schedule-cell">Wednesday</div>
            <div class="schedule-cell">Thursday</div>
            <div class="schedule-cell">Friday</div>
            <div class="schedule-cell">Saturday</div>
        </div>
        


        {{!-- For each timeslot --}}
        {{#each timeSlots}}
            <div class="schedule-row">
                {{!-- Display every timeslot --}}
                <div class="schedule-cell">{{this}}</div>
                {{!-- For each day --}}
                {{#each ../days}}
                    <div class="schedule-cell">
                        {{!-- For each object in schedule --}}
                        {{#each ../../schedule}}
                        {{!-- if schedule.day == days.day --}}
                            {{#if_eq this.day ../this}}
                            {{!-- if schedule.time == timeSlots.time --}}
                                {{#if_eq this.time ../../this}}
                                {{!-- Display schedule.name --}}
                                    {{#if ../../../view}}
                                            {{this.name}}
                                    {{else}}
                                        <button type="button" id ="{{this.session_id}}_{{../this}}_{{../../this}}_{{this.name}}">
                                            {{this.name}}
                                        </button>
                                    {{/if}}
                                {{/if_eq}}
                            {{/if_eq}}
                        {{/each}}
                    </div>
                {{/each}}
            </div>
        {{/each}}


    </div>
    {{#if view}}
        <div class="submit-button">
            <button type="button" id="submit-button" class="anim_button" onclick="window.location.href='/schedule'"><span></span>CREATE NEW SCHEDULE</button>
        </div>
    {{else}}
        <div class="submit-button">
            <button type="submit" id="submit-button" class="anim_button"><span></span>CREATE SCHEDULE</button>
        </div>
        {{#if message}}
            <h1 style="color:rgb(255, 255, 255)">{{message}}</h1>
            <button type="button" id="buy-membership-button" class="anim_button" onclick="window.location.href='/memberships'"><span></span>BUY MEMBERSHIP</button>
            <button type="button" id="go-home-button" class="anim_button" onclick="window.location.href='/home'"><span></span>GO HOME</button>
        {{/if}}
    {{/if}}
    <input type="hidden" id="selectedSessionIDs" name="sessionIDs" value=""></input>
</form>

<script>
// Store selected button IDs for each date and name combination
const selectedButtons = {};
let selectedSessionIds = [];

// Select all buttons
const buttons = document.querySelectorAll('.schedule-cell button');

// Add click event listener to each button
buttons.forEach(button => {
    button.addEventListener('click', function() {
        // Get the clicked button's ID, date, and name
        const buttonId = this.getAttribute('id');
        const [sessionId, buttonDate, buttonTime, buttonName] = buttonId.split('_');

        // Check if the clicked button is already selected
        const isAlreadySelected = this.classList.contains('selected');

        if (isAlreadySelected) {
            // Deselect the clicked button
            this.classList.remove('selected');

            // Remove the button from selectedButtons and session IDs
            delete selectedButtons[buttonDate + '_' + buttonName];
            delete selectedButtons[buttonDate + '_' + buttonTime];
            const index = selectedSessionIds.indexOf(sessionId);
            if (index > -1) {
                selectedSessionIds.splice(index, 1);
            }
        } else {
            // Check if there's a selected button for the same date and name
            const prevSelectedButtonId = selectedButtons[buttonDate + '_' + buttonName];
            // Check if there's a selected button for the same date and time
            const prevSelectedButtonAtSameTimeId = selectedButtons[buttonDate + '_' + buttonTime];

            // Deselect the previously selected button for the same date and name (if any)
            if (prevSelectedButtonId && prevSelectedButtonId !== buttonId) {
                const prevSelectedButton = document.getElementById(prevSelectedButtonId);
                if (prevSelectedButton) {
                    prevSelectedButton.classList.remove('selected');
                    const prevSessionId = prevSelectedButtonId.split('_')[0];
                    const index = selectedSessionIds.indexOf(prevSessionId);
                    if (index > -1) {
                        selectedSessionIds.splice(index, 1);
                    }
                }
            }

            // Deselect the previously selected button for the same date and time (if any)
            if (prevSelectedButtonAtSameTimeId && prevSelectedButtonAtSameTimeId !== buttonId) {
                const prevSelectedButtonAtSameTime = document.getElementById(prevSelectedButtonAtSameTimeId);
                if (prevSelectedButtonAtSameTime) {
                    prevSelectedButtonAtSameTime.classList.remove('selected');
                    const prevSessionId = prevSelectedButtonAtSameTimeId.split('_')[0];
                    const index = selectedSessionIds.indexOf(prevSessionId);
                    if (index > -1) {
                        selectedSessionIds.splice(index, 1);
                    }
                }
            }

            // Select the clicked button
            this.classList.add('selected');

            // Update the selected button for the same date and name
            selectedButtons[buttonDate + '_' + buttonName] = buttonId;
            // Update the selected button for the same date and time
            selectedButtons[buttonDate + '_' + buttonTime] = buttonId;

            // Add the session ID to the list of selected session IDs if not already present
            if (!selectedSessionIds.includes(sessionId)) {
                selectedSessionIds.push(sessionId);
            }
        }

        console.log("Selected session IDs:", selectedSessionIds);
        document.getElementById('selectedSessionIDs').value = selectedSessionIds.join(',');
    });
});
</script>

